#!/bin/bash

#/ NAME
#/     shell -- sets up bash subshell with environment and paths
#/
#/ SYNOPSIS
#/     shell

# figure out the project root under which bin, lib live
shome="$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"

# load a jason bourne library
source "$shome/libexec/_jason"
require awsme
require build

DEFINE_string "working" "$shome" "Working directory" "w"
DEFINE_boolean "clean" "$FLAGS_FALSE" "Run sub-shell disabling profiles and prompts" "c"
DEFINE_string "shell" "$SHELL" "Run a different shell" "S"
DEFINE_string "rcfile" "" "Run a different rcfile, implies --clean"

# entry point
function main {
  cd "$FLAGS_working"

  if [[ -n "$FLAGS_rcfile" ]]; then
    FLAGS_clean="$FLAGS_TRUE"
  fi

  if [[ "$FLAGS_clean" = "$FLAGS_TRUE" ]]; then
    unset PROMPT_COMMAND
    if [[ -n "$FLAGS_rcfile" ]]; then
      if [[ "$#" > 0 ]]; then
        exec $FLAGS_shell --noprofile --rcfile "$FLAGS_rcfile" -c "$*"
      else
        exec $FLAGS_shell --noprofile --rcfile "$FLAGS_rcfile"
      fi
    else
      exec $FLAGS_shell --noprofile
    fi
  else
    if [[ "$#" > 0 ]]; then
      exec $FLAGS_shell -c "$*"
    else
      exec $FLAGS_shell
    fi
  fi
}

function dna {
  cat <<EOF
    { "run_list": ["awsme"] }
EOF
}

require sub "$BASH_SOURCE" "$@"
